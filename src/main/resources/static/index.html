<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Test Client</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100">

<div class="container mx-auto max-w-lg p-5">

    <!-- Connection Panel -->
    <div id="connect-panel" class="bg-white p-6 rounded-lg shadow-md mb-4">
        <h2 class="text-xl font-semibold mb-3">Connect to Chat</h2>
        <div class="mb-3">
            <label for="username" class="block text-sm font-medium text-gray-700">Your Username:</label>
            <input type="text" id="username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="e.g., user1">
        </div>
        <button id="connect-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
            Connect
        </button>
    </div>

    <!-- Chat Panel -->
    <div id="chat-panel" class="hidden bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-3">Chatting as: <span id="current-user" class="font-bold text-blue-600"></span></h2>

        <div class="flex gap-2 mb-3">
            <input type="text" id="receiver" class="block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="Chatting with... (e.g., user2)">
            <button id="load-history-btn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 whitespace-nowrap">
                Load History
            </button>
        </div>

        <pre id="messages" class="h-64 overflow-y-auto bg-gray-50 p-3 rounded-md border border-gray-200 mb-3 whitespace-pre-wrap"></pre>

        <div class="flex gap-2">
            <input type="text" id="message" class="block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="Type your message...">
            <button id="send-btn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                Send
            </button>
        </div>
        <button id="disconnect-btn" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 mt-4">
            Disconnect
        </button>
    </div>
</div>

<script>
    // DOM Elements
    const connectPanel = document.getElementById('connect-panel');
    const chatPanel = document.getElementById('chat-panel');
    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    const loadHistoryBtn = document.getElementById('load-history-btn');
    const sendBtn = document.getElementById('send-btn');
    const usernameInput = document.getElementById('username');
    const receiverInput = document.getElementById('receiver');
    const messageInput = document.getElementById('message');
    const messagesDiv = document.getElementById('messages');
    const currentUserSpan = document.getElementById('current-user');

    let stompClient = null;
    let currentUser = '';

    // --- Event Listeners ---
    connectBtn.onclick = connect;
    disconnectBtn.onclick = disconnect;
    sendBtn.onclick = sendMessage;
    loadHistoryBtn.onclick = loadHistory;

    function setConnected(connected) {
        connectPanel.classList.toggle('hidden', connected);
        chatPanel.classList.toggle('hidden', !connected);
        if (connected) {
            currentUserSpan.textContent = currentUser;
        } else {
            messagesDiv.innerHTML = '';
        }
    }

    function log(message) {
        messagesDiv.innerHTML += `<i>${message}</i>\n`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showMessage(msg) {
        const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
        messagesDiv.innerHTML += `[${time}] <b>${msg.senderId}:</b> ${msg.content}\n`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function connect() {
        currentUser = usernameInput.value;
        if (!currentUser) {
            alert('Please enter a username');
            return;
        }

        // This URL MUST match your WebSocketConfigMessaging
        // It passes the username as a query param to your HandshakeHandler
        const url = `https://codewithketan.me/ws-messages?username=${currentUser}`;
        const socket = new SockJS(url);
        stompClient = Stomp.over(socket);

        stompClient.connect({},
            (frame) => { // On Connect
                log('Connected: ' + frame);
                setConnected(true);

                // Subscribe to the user-specific queue
                // Your controller sends to /queue/messages, so Spring routes it here
                stompClient.subscribe('/user/queue/messages', (message) => {
                    showMessage(JSON.parse(message.body));
                });
            },
            (error) => { // On Error
                log('Connection error: ' + error);
                setConnected(false);
            }
        );
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        setConnected(false);
        log('Disconnected');
    }

    function sendMessage() {
        const receiverId = receiverInput.value;
        const content = messageInput.value;
        if (!content || !receiverId) {
            alert('Please enter a receiver and a message');
            return;
        }

        const chatMessage = {
            senderId: currentUser,
            receiverId: receiverId,
            content: content,
            timestamp: new Date().toISOString()
            // 'read' and 'id' will be set by the backend
        };

        // Send to the STOMP endpoint defined in your MessageController
        stompClient.send('/app/chat', {}, JSON.stringify(chatMessage));
        messageInput.value = '';
    }

    async function loadHistory() {
        const receiverId = receiverInput.value;
        if (!receiverId) {
            alert('Please enter a receiver to load history');
            return;
        }

        log(`--- Loading history with ${receiverId} ---`);
        try {
            // Call the REST endpoint from your MessageController
            const response = await fetch(`https://codewithketan.me/api/v1/messages/chat?user1=${currentUser}&user2=${receiverId}`);
            if (!response.ok) {
                throw new Error('Failed to fetch history');
            }
            const history = await response.json();

            if (history.length === 0) {
                log('--- No history found ---');
            } else {
                history.forEach(showMessage);
                log('--- End of history ---');
            }
        } catch (error) {
            log(`Error loading history: ${error.message}`);
        }
    }
</script>
</body>
</html>