<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chat Room Test Client</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
        .msg-sent { text-align: right; }
        .msg-recv { text-align: left; }
        .msg { padding: .4rem .6rem; border-radius: .5rem; display: inline-block; max-width: 80%; word-wrap: break-word; }
    </style>
</head>
<body class="bg-gray-100 p-6">
<div class="max-w-2xl mx-auto">
    <div class="bg-white p-4 rounded shadow mb-4">
        <h1 class="text-xl font-semibold mb-3">Chat Room Tester</h1>

        <label class="block text-sm">Server Host (leave blank for current host)</label>
        <input id="serverHost" class="w-full p-2 border rounded mb-2" placeholder="e.g., https://codewithketan.me or http://localhost:8080" />

        <div class="grid grid-cols-2 gap-2 mb-2">
            <input id="roomCode" class="p-2 border rounded" placeholder="roomCode (UUID string)" />
            <input id="userId" class="p-2 border rounded" placeholder="userId (string)" />
        </div>

        <div class="flex gap-2">
            <button id="connectBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Connect</button>
            <button id="disconnectBtn" class="bg-red-600 text-white px-4 py-2 rounded" disabled>Disconnect</button>
        </div>

        <p id="status" class="text-sm mt-3 text-gray-600">Disconnected</p>
    </div>

    <div id="chatPanel" class="hidden bg-white p-4 rounded shadow">
        <div id="messages" class="h-64 overflow-y-auto p-2 border rounded bg-gray-50 mb-3"></div>

        <div class="flex gap-2">
            <input id="messageInput" class="flex-1 p-2 border rounded" placeholder="Type a message..." />
            <button id="sendBtn" class="bg-green-600 text-white px-4 py-2 rounded">Send</button>
        </div>
    </div>
</div>

<script>
    let socket = null;
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const serverHostInput = document.getElementById('serverHost');
    const roomCodeInput = document.getElementById('roomCode');
    const userIdInput = document.getElementById('userId');
    const statusP = document.getElementById('status');
    const chatPanel = document.getElementById('chatPanel');
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    function logStatus(s) { statusP.textContent = s; }

    function formatTime(ts) {
        try {
            const d = new Date(Number(ts));
            return d.toLocaleTimeString();
        } catch (e) { return ''; }
    }

    function appendMessage(senderId, text, timestamp, isMe) {
        const wrapper = document.createElement('div');
        wrapper.className = isMe ? 'msg-sent mb-2' : 'msg-recv mb-2';

        const bubble = document.createElement('div');
        bubble.className = 'msg';
        bubble.style.background = isMe ? '#DCFCE7' : '#FFFFFF';
        bubble.style.border = '1px solid #E5E7EB';
        bubble.innerHTML = `<div class="text-xs text-gray-500 mb-1">${senderId} â€¢ ${formatTime(timestamp)}</div>
                          <div>${escapeHtml(text)}</div>`;

        wrapper.appendChild(bubble);
        messagesDiv.appendChild(wrapper);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    connectBtn.onclick = () => {
        const roomCode = roomCodeInput.value.trim();
        const userId = userIdInput.value.trim();
        if (!roomCode || !userId) {
            alert('Please enter roomCode and userId');
            return;
        }

        // determine host
        let host = serverHostInput.value.trim();
        if (!host) {
            // use current origin (works if served from same host)
            host = window.location.origin;
        }
        // ensure no trailing slash
        host = host.replace(/\/$/, '');

        const protocol = host.startsWith('https') ? 'wss' : 'ws';
        const wsUrl = `${protocol}://${host.replace(/^https?:\/\//, '')}/chat?roomCode=${encodeURIComponent(roomCode)}&userId=${encodeURIComponent(userId)}`;

        // open websocket
        socket = new WebSocket(wsUrl);

        logStatus('Connecting...');
        socket.onopen = () => {
            logStatus('Connected');
            connectBtn.disabled = true;
            disconnectBtn.disabled = false;
            chatPanel.classList.remove('hidden');
            messagesDiv.innerHTML = '';
        };

        socket.onmessage = (evt) => {
            // server sends JSON payload like: { senderId: "...", message: "...", timestamp: 123456789 }
            try {
                const obj = JSON.parse(evt.data);
                const sender = obj.senderId || 'unknown';
                const text = obj.message || obj.msg || evt.data;
                const ts = obj.timestamp || Date.now();
                const isMe = (sender === userId);
                appendMessage(sender, text, ts, isMe);
            } catch (e) {
                // If not JSON, show raw
                appendMessage('server', evt.data, Date.now(), false);
            }
        };

        socket.onclose = (evt) => {
            logStatus('Disconnected');
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            chatPanel.classList.add('hidden');
        };

        socket.onerror = (err) => {
            console.error('WebSocket error', err);
            logStatus('WebSocket error (check console)');
        };
    };

    disconnectBtn.onclick = () => {
        if (socket) socket.close();
    };

    sendBtn.onclick = () => {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            alert('Not connected');
            return;
        }
        const text = messageInput.value.trim();
        if (!text) return;
        // client sends minimal JSON { "message": "..." }
        const payload = JSON.stringify({ message: text });
        socket.send(payload);
        messageInput.value = '';
    };

    // Allow Enter to send
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendBtn.click();
        }
    });
</script>
</body>
</html>
