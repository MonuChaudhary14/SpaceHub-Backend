<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Online Users Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f7fa;
            padding: 30px;
        }
        h1 {
            color: #333;
        }
        input, button {
            margin: 5px 0;
            padding: 8px 12px;
            font-size: 14px;
        }
        #online-list {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background: #fff;
            width: 300px;
        }
        .user {
            background: #eaf3ff;
            padding: 5px 10px;
            margin: 4px 0;
            border-radius: 6px;
        }
    </style>
</head>
<body>
<h1>ðŸ‘¥ Community Online Users Test</h1>

<label>Community ID:</label>
<input type="number" id="communityId" placeholder="e.g. 1" value="1" /><br/>

<label>Your Email:</label>
<input type="email" id="email" placeholder="you@example.com" /><br/>

<button onclick="connect()">Join Community</button>
<button onclick="leave()">Leave Community</button>

<div id="status" style="margin-top: 10px; color: green;"></div>

<h3>Currently Online:</h3>
<div id="online-list">
    <p>No users online yet.</p>
</div>

<script>
    let stompClient = null;
    let communityId = null;
    let email = null;

    function connect() {
        communityId = document.getElementById("communityId").value;
        email = document.getElementById("email").value;

        if (!communityId || !email) {
            alert("Please enter both Community ID and Email!");
            return;
        }

        const socket = new SockJS("http://localhost:8080/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            document.getElementById("status").innerText = "âœ… Connected to WebSocket";

            // Subscribe to updates for this community
            stompClient.subscribe(`/topic/community.${communityId}.online`, function (message) {
                const data = JSON.parse(message.body);
                updateOnlineList(data.onlineEmails);
            });

            // Send enter presence
            stompClient.send(
                "/app/presence/enter",
                {},
                JSON.stringify({
                    communityId: parseInt(communityId),
                    email: email,
                    action: "join"
                })
            );
        });
    }

    function updateOnlineList(emails) {
        const container = document.getElementById("online-list");
        container.innerHTML = "";

        if (!emails || emails.length === 0) {
            container.innerHTML = "<p>No users online yet.</p>";
            return;
        }

        emails.forEach(e => {
            const div = document.createElement("div");
            div.className = "user";
            div.innerText = e;
            container.appendChild(div);
        });
    }

    function leave() {
        if (stompClient && stompClient.connected) {
            stompClient.send("/app/presence/leave", {}, {});
            stompClient.disconnect(() => {
                document.getElementById("status").innerText = "âŒ Disconnected";
            });
        }
    }

    // Handle page/tab close
    window.addEventListener("beforeunload", () => {
        leave();
    });
</script>
</body>
</html>
